# SQL Server Check Configuration for SCCM Reporting Server (Windows Authentication Alternative)
# Monitors SQL Server Reporting Services database and performance without username/password
# Uses Windows Authentication with minimal viable configuration

init_config:

instances:
  # Main SQL Server instance monitoring for Reporting Services with Windows Authentication
  - host: localhost,1433
    connection_string: "Trusted_Connection=yes"
    connector: odbc
    driver: ODBC Driver 18 for SQL Server
    tags:
      - role:sccm-sql-reporting-server
      - database:reportserver
      - auth:windows
    
    # Basic Database Monitoring Configuration (simplified)
    dbm: false  # Disabled to reduce authentication requirements
    
    # Essential custom queries for SSRS monitoring (basic level)
    custom_queries:
      # Basic ReportServer Database Check
      - query: |
          SELECT 
            'ReportServer' as database_name,
            COUNT(*) as table_count
          FROM INFORMATION_SCHEMA.TABLES
          WHERE TABLE_CATALOG = 'ReportServer'
        columns:
          - name: database_name
            type: tag
          - name: table_count
            type: gauge
        tags:
          - query:reportserver_basic_check
      
      # Basic ReportServerTempDB Check
      - query: |
          SELECT 
            'ReportServerTempDB' as database_name,
            COUNT(*) as table_count
          FROM INFORMATION_SCHEMA.TABLES
          WHERE TABLE_CATALOG = 'ReportServerTempDB'
        columns:
          - name: database_name
            type: tag
          - name: table_count
            type: gauge
        tags:
          - query:reportserver_tempdb_check
      
      # SQL Server Basic Health Check
      - query: |
          SELECT 
            @@SERVERNAME as server_name,
            @@VERSION as sql_version,
            GETDATE() as current_time
        columns:
          - name: server_name
            type: tag
          - name: sql_version
            type: tag
          - name: current_time
            type: tag
        tags:
          - query:sql_server_info
    
    # Performance counters (essential only)
    include_task_scheduler_metrics: false
    include_db_fragmentation_metrics: false  # Requires additional permissions
    include_fci_metrics: false
    
    # Log collection (SSRS logs)
    logs:
      - type: file
        path: C:\Program Files\Microsoft SQL Server\MSRS13.MSSQLSERVER\Reporting Services\LogFiles\ReportServerService*.log
        source: ssrs
        service: ssrs
        log_processing_rules:
          - type: multi_line
            name: new_log_start_with_timestamp
            pattern: \w+\s+\d{2}\s+\d{2}:\d{2}:\d{2}
        tags:
          - auth:windows
          - role:sccm-sql-reporting-server
      
      - type: file
        path: C:\Program Files\Microsoft SQL Server\MSRS13.MSSQLSERVER\Reporting Services\LogFiles\ReportServerWebApp*.log
        source: ssrs-webapp
        service: ssrs-webapp
        log_processing_rules:
          - type: multi_line
            name: new_log_start_with_timestamp
            pattern: \w+\s+\d{2}\s+\d{2}:\d{2}:\d{2}
        tags:
          - auth:windows
          - role:sccm-sql-reporting-server
      
      # Basic SQL Server logs for reporting server
      - type: file
        path: C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Log\ERRORLOG
        source: sqlserver
        service: sqlserver-reporting
        log_processing_rules:
          - type: multi_line
            name: new_log_start_with_date
            pattern: \d{4}-\d{2}-\d{2}
        tags:
          - auth:windows
          - role:sccm-sql-reporting-server

# Alternative configuration notes:
# 1. Uses Windows Authentication (Trusted_Connection=yes) instead of username/password
# 2. DBM disabled to reduce permission requirements
# 3. Simplified custom queries using INFORMATION_SCHEMA views (more accessible)
# 4. Essential performance counters only
# 5. SSRS log collection maintained
# 6. Added auth:windows tag for identification
# 7. Basic SQL Server health monitoring included
# 8. Suitable for environments where service accounts cannot be used