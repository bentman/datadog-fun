# SQL Server Check Configuration for SCCM Database (Windows Authentication Alternative)
# Monitors SQL Server performance and SCCM database health without username/password
# Uses Windows Authentication with minimal viable configuration

init_config:

instances:
  # Main SQL Server instance monitoring with Windows Authentication
  - host: localhost,1433
    connection_string: "Trusted_Connection=yes"
    connector: odbc
    driver: ODBC Driver 18 for SQL Server
    tags:
      - role:sccm-sql-server
      - database:sccm
      - auth:windows
    
    # Basic Database Monitoring Configuration (simplified)
    dbm: false  # Disabled to reduce authentication requirements
    
    # Essential custom queries for SCCM monitoring (basic level)
    custom_queries:
      # Basic SCCM Database Size Monitoring (using simpler query)
      - query: |
          SELECT 
            'SCCM' as database_name,
            COUNT(*) as file_count
          FROM sys.database_files
          WHERE type IN (0,1)
        columns:
          - name: database_name
            type: tag
          - name: file_count
            type: gauge
        tags:
          - query:sccm_database_files
      
      # SQL Server Basic Health Check
      - query: |
          SELECT 
            @@SERVERNAME as server_name,
            @@VERSION as sql_version,
            GETDATE() as current_time
        columns:
          - name: server_name
            type: tag
          - name: sql_version
            type: tag
          - name: current_time
            type: tag
        tags:
          - query:sql_server_info
    
    # Performance counters (essential only)
    include_task_scheduler_metrics: false
    include_db_fragmentation_metrics: false  # Requires additional permissions
    include_fci_metrics: false
    
    # Log collection (basic SQL Server logs)
    logs:
      - type: file
        path: C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Log\ERRORLOG
        source: sqlserver
        service: sqlserver
        log_processing_rules:
          - type: multi_line
            name: new_log_start_with_date
            pattern: \d{4}-\d{2}-\d{2}
        tags:
          - auth:windows
          - role:sccm-sql-server
      
      - type: file
        path: C:\Program Files\Microsoft SQL Server\MSSQL15.MSSQLSERVER\MSSQL\Log\SQLAGENT.OUT
        source: sqlserver
        service: sqlserver-agent
        log_processing_rules:
          - type: multi_line
            name: new_log_start_with_date
            pattern: \d{4}-\d{2}-\d{2}
        tags:
          - auth:windows
          - role:sccm-sql-server

# Alternative configuration notes:
# 1. Uses Windows Authentication (Trusted_Connection=yes) instead of username/password
# 2. DBM disabled to reduce permission requirements
# 3. Simplified custom queries that work with basic permissions
# 4. Essential performance counters only
# 5. Basic log collection maintained
# 6. Added auth:windows tag for identification
# 7. Suitable for environments where service accounts cannot be used